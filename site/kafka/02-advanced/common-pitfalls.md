---
title: 常见坑位与排查思路
date: 2026-02-24
tags:
  - kafka
  - troubleshooting
summary: 汇总 Kafka 项目里高频踩坑场景，并给出一线可执行的排查顺序。
order: 10
---

# 常见坑位与排查思路

## 坑 1: 误以为全局有序

现象:

- 业务声称“消息乱序”。

根因:

- 同一业务实体消息被分散到不同分区。

排查:

1. 看是否使用稳定 key。
2. 看 key 是否发生了序列化或字段变更。
3. 看是否在扩分区后引入分布变化。

## 坑 2: 重复消费导致脏写

现象:

- 下游数据库出现重复记录或状态回退。

根因:

- at-least-once 语义下重复是正常现象，但业务未做幂等。

排查:

1. 检查消费逻辑是否有幂等键。
2. 检查 offset 提交时机是否晚于业务写入。
3. 检查异常重试是否导致同批消息重复处理。

## 坑 3: 消费堆积持续增长

现象:

- lag 不断上升，恢复速度慢。

根因:

- 消费处理能力不足，或频繁 rebalance。

排查:

1. 先看消费者处理耗时与错误率。
2. 再看分区数是否限制并行。
3. 检查 `max.poll.interval.ms` 与批量大小配置。

## 坑 4: 只调客户端不看集群

现象:

- 调了很多客户端参数，问题仍在。

根因:

- Broker 磁盘、网络、ISR 异常才是主因。

排查:

1. 看 `UnderReplicatedPartitions`。
2. 看 Broker 资源瓶颈与慢盘。
3. 看跨机房网络延迟和抖动。

## 快速排查流程

```mermaid
flowchart LR
    A[发现异常] --> B[确认业务影响范围]
    B --> C[看 Lag/错误率]
    C --> D[看 Broker 健康与副本]
    D --> E[定位到参数/资源/代码]
    E --> F[最小改动修复并验证]
```

## 结论

- Kafka 问题通常不是单点参数能解决。
- 以“语义设计 + 监控体系 + 故障演练”三件套治理，长期成本最低。

